"use strict";(()=>{var e={};e.id=487,e.ids=[487],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},2694:e=>{e.exports=require("http2")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},5816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},1001:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>S,patchFetch:()=>T,requestAsyncStorage:()=>c,routeModule:()=>I,serverHooks:()=>p,staticGenerationAsyncStorage:()=>E});var a={};i.r(a),i.d(a,{POST:()=>l,dynamic:()=>u});var s=i(9303),d=i(8716),r=i(670),n=i(7070),o=i(7813);let u="force-dynamic";async function l(e,{params:t}){try{let i=await e.json();if(!i.questionId)return n.NextResponse.json({error:"Question ID is required"},{status:400});return await o.C.createOrUpdateFinding(t.id,i.questionId,i),n.NextResponse.json({success:!0})}catch(e){return console.error("Failed to save finding:",e),n.NextResponse.json({error:"Failed to save finding"},{status:500})}}let I=new s.AppRouteRouteModule({definition:{kind:d.x.APP_ROUTE,page:"/api/audits/[id]/findings/route",pathname:"/api/audits/[id]/findings",filename:"route",bundlePath:"app/api/audits/[id]/findings/route"},resolvedPagePath:"/workspaces/logosaudit/app/api/audits/[id]/findings/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:E,serverHooks:p}=I,S="/api/audits/[id]/findings/route";function T(){return(0,r.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:E})}},7813:(e,t,i)=>{i.d(t,{C:()=>n});var a=i(2686);process.env.NEXT_PUBLIC_FIREBASE_API_KEY,process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,process.env.NEXT_PUBLIC_FIREBASE_APP_ID;let s={};class d{static async create(e,t){let i=(0,a.hJ)(s,e);return await (0,a.ET)(i,{...t,createdAt:a.EK.now(),updatedAt:a.EK.now()})}static async getById(e,t){let i=(0,a.JU)(s,e,t),d=await (0,a.QT)(i);return d.exists()?{id:d.id,...d.data()}:null}static async query(e,t=[]){let i=(0,a.hJ)(s,e),d=(0,a.IO)(i,...t);return(await (0,a.PL)(d)).docs.map(e=>({id:e.id,...e.data()}))}static async update(e,t,i){let d=(0,a.JU)(s,e,t);await (0,a.r7)(d,{...i,updatedAt:a.EK.now()})}static async delete(e,t){let i=(0,a.JU)(s,e,t);await (0,a.oe)(i)}static async getAll(e,t,i="desc"){(0,a.hJ)(s,e);let d=[];return t&&d.push((0,a.Xo)(t,i)),this.query(e,d)}static async getByField(e,t,i){return this.query(e,[(0,a.ar)(t,"==",i)])}static timestampToDate(e){return e?.toDate?e.toDate():e instanceof Date?e:new Date(e)}static dateToTimestamp(e){return a.EK.fromDate(e)}}let r={USERS:"users",AUDITS:"audits",INTERVIEWEES:"interviewees",AUDIT_FINDINGS:"auditFindings",OMITTED_QUESTIONS:"omittedQuestions"};class n{static async createAudit(e){let t=(0,a.hJ)(s,r.USERS),i=(0,a.IO)(t,(0,a.ar)("email","==",e.leadAuditorEmail)),d=await (0,a.PL)(i);return(0,a.i3)(s,async t=>{let i;if(d.empty){let d=(0,a.JU)((0,a.hJ)(s,r.USERS)),n={uid:"",email:e.leadAuditorEmail,name:e.leadAuditorName,title:e.leadAuditorTitle,createdAt:a.EK.now(),updatedAt:a.EK.now()};t.set(d,n),i={...n,id:d.id}}else{let e=d.docs[0];i={id:e.id,...e.data()}}let n=(0,a.JU)((0,a.hJ)(s,r.AUDITS)),o={title:e.title,dateStarted:a.EK.now(),status:"IN_PROGRESS",companyName:e.companyName,companyAddress:e.companyAddress,leadAuditorId:i.id,leadAuditorEmail:i.email,isoStandard:e.isoStandard,selectedSections:e.selectedSections,customScope:e.customScope,completionPercentage:0,hasDocuments:!1,createdAt:a.EK.now(),updatedAt:a.EK.now()};t.set(n,o);let u=[];for(let i of e.interviewees){let e=(0,a.JU)((0,a.hJ)(s,r.INTERVIEWEES)),d={auditId:n.id,name:i.name,jobTitle:i.jobTitle,department:i.department,email:i.email,createdAt:a.EK.now(),updatedAt:a.EK.now()};t.set(e,d),u.push({...d,id:e.id})}return{...o,id:n.id,leadAuditor:i,interviewees:u,findings:[],omittedQuestions:[],documents:[]}})}static async getAllAudits(){return Promise.all((await d.getAll(r.AUDITS,"dateStarted","desc")).map(async e=>{let[t,i,a,s]=await Promise.all([d.getById(r.USERS,e.leadAuditorId),d.getByField(r.INTERVIEWEES,"auditId",e.id),this.getAuditFindingsCount(e.id),this.getOmittedQuestionsCount(e.id)]);return{...e,leadAuditor:t,interviewees:i,_count:{findings:a,omittedQuestions:s}}}))}static async getAuditById(e){let t=await d.getById(r.AUDITS,e);if(!t)return null;let[i,a,s,n]=await Promise.all([d.getById(r.USERS,t.leadAuditorId),d.getByField(r.INTERVIEWEES,"auditId",e),d.getByField(r.AUDIT_FINDINGS,"auditId",e),d.getByField(r.OMITTED_QUESTIONS,"auditId",e)]);return{...t,leadAuditor:i,interviewees:a,findings:s,omittedQuestions:n}}static async updateAudit(e,t){await d.update(r.AUDITS,e,t)}static async deleteAudit(e){let t=(0,a.qs)(s),i=(0,a.JU)(s,r.AUDITS,e);t.delete(i);let[n,o,u]=await Promise.all([d.getByField(r.INTERVIEWEES,"auditId",e),d.getByField(r.AUDIT_FINDINGS,"auditId",e),d.getByField(r.OMITTED_QUESTIONS,"auditId",e)]);[...n,...o,...u].forEach(e=>{if(e.id){let i="auditId"in e&&"questionId"in e&&"score"in e?r.AUDIT_FINDINGS:"auditId"in e&&"questionId"in e&&"reason"in e?r.OMITTED_QUESTIONS:r.INTERVIEWEES,d=(0,a.JU)(s,i,e.id);t.delete(d)}}),await t.commit()}static async getAuditFindingsCount(e){return(await d.getByField(r.AUDIT_FINDINGS,"auditId",e)).length}static async getOmittedQuestionsCount(e){return(await d.getByField(r.OMITTED_QUESTIONS,"auditId",e)).length}static async createOrUpdateFinding(e,t,i){let s=await d.query(r.AUDIT_FINDINGS,[(0,a.ar)("auditId","==",e),(0,a.ar)("questionId","==",t)]);s.length>0?await d.update(r.AUDIT_FINDINGS,s[0].id,i):await d.create(r.AUDIT_FINDINGS,{auditId:e,questionId:t,notes:"",evidenceNotes:"",timestamp:a.EK.now(),...i})}static async toggleQuestionOmission(e,t,i){let s=await d.query(r.OMITTED_QUESTIONS,[(0,a.ar)("auditId","==",e),(0,a.ar)("questionId","==",t)]);s.length>0?await d.delete(r.OMITTED_QUESTIONS,s[0].id):await d.create(r.OMITTED_QUESTIONS,{auditId:e,questionId:t,reason:i,omittedAt:a.EK.now()})}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[276,972,686],()=>i(1001));module.exports=a})();